name: Deploy to Linux 1 (Agents)

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
    paths:
      - 'agents/**'
      - 'docker-compose.agents.yml'
      - 'Dockerfile.agent'
      - '.github/workflows/deploy-linux1.yaml'
      
jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup SSH for Linux 1
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_KEY_L1 }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H ${{ secrets.LINUX_1_IP }} >> ~/.ssh/known_hosts
          ssh-keyscan -H ${{ secrets.LINUX_2_IP }} >> ~/.ssh/known_hosts
      
      - name: Deploy Agents to Linux 1
        env:
          LINUX_1_IP: ${{ secrets.LINUX_1_IP }}
          LINUX_2_IP: ${{ secrets.LINUX_2_IP }}
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          DB_NAME: ${{ secrets.DB_NAME }}
          DB_PORT: ${{ secrets.DB_PORT }}
        run: |
          ssh -i ~/.ssh/id_ed25519 root@${{ secrets.LINUX_1_IP }} bash -s << 'EOF'
          set -e
          cd /root/aa-master-project
          
          echo "=== [1/7] Pulling latest code ==="
          git pull origin main
          
          echo "=== [2/7] Generating .env file ==="
          echo "# Generated by GitHub Actions" > .env
          echo "DB_HOST=localhost" >> .env
          echo "DB_PORT=${DB_PORT}" >> .env
          echo "DB_NAME=${DB_NAME}" >> .env
          echo "DB_USER=${DB_USER}" >> .env
          echo "DB_PASS=${DB_PASSWORD}" >> .env
          echo "LINUX_1_IP=${LINUX_1_IP}" >> .env
          echo "LINUX_2_IP=${LINUX_2_IP}" >> .env
          
          echo "=== [3/7] .env file created ==="
          cat .env
          
          echo "=== [4/7] Stopping old containers ==="
          docker compose -f docker-compose.agents.yml down || true
          docker rm -f aat-monitor-db 2>/dev/null || true
          
          echo "=== [5/7] Building and starting agents ==="
          docker compose -f docker-compose.agents.yml up -d --build
          
          echo "=== [6/7] Waiting 10 seconds ==="
          sleep 10
          
          echo "=== [7/7] Checking status ==="
          docker ps --filter "name=aat-"
          docker logs aat-monitor-db --tail 30 || true
          
          echo "=== Deployment completed ==="
          EOF
