name: Deploy to Linux 1 (Agents)

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
    paths:
      - 'agents/**'
      - 'docker-compose.agents.yml'
      - 'Dockerfile.agent'
      - '.github/workflows/deploy-linux1.yaml'
      
jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup SSH for Linux 1
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_KEY_L1 }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H ${{ secrets.LINUX_1_IP }} >> ~/.ssh/known_hosts
          ssh-keyscan -H ${{ secrets.LINUX_2_IP }} >> ~/.ssh/known_hosts
      
      - name: Create .env file locally
        run: |
          cat > .env << EOF
          # Generated by GitHub Actions
          DB_HOST=localhost
          DB_PORT=${{ secrets.DB_PORT }}
          DB_NAME=${{ secrets.DB_NAME }}
          DB_USER=${{ secrets.DB_USER }}
          DB_PASS=${{ secrets.DB_PASSWORD }}
          LINUX_1_IP=${{ secrets.LINUX_1_IP }}
          LINUX_2_IP=${{ secrets.LINUX_2_IP }}
          EOF
          echo "=== .env file created locally ==="
          cat .env
      
      - name: Deploy Agents to Linux 1
        run: |
          # First, prepare the server
          ssh -i ~/.ssh/id_ed25519 root@${{ secrets.LINUX_1_IP }} bash << 'EOF'
          set -e
          cd /root
          
          echo "=== [1/8] Cleanup old directory ==="
          if [ -d "/root/aa-master-project" ]; then
            echo "Removing old /root/aa-master-project directory..."
            rm -rf /root/aa-master-project
            echo "Cleanup completed"
          else
            echo "No cleanup needed"
          fi
          
          cd /root/master-project
          
          echo "=== [2/8] Resetting local changes ==="
          git reset --hard HEAD
          git clean -fd
          
          echo "=== [3/8] Pulling latest code ==="
          git pull origin main
          EOF
          
          # Now copy .env AFTER git pull
          echo "=== [4/8] Copying .env file to server ==="
          scp -i ~/.ssh/id_ed25519 .env root@${{ secrets.LINUX_1_IP }}:/root/master-project/.env
          
          # Continue with deployment
          ssh -i ~/.ssh/id_ed25519 root@${{ secrets.LINUX_1_IP }} bash << 'EOF'
          set -e
          cd /root/master-project
          
          echo "=== [5/8] Checking .env file ==="
          cat .env
          
          echo "=== [6/8] Stopping old containers ==="
          docker compose -f docker-compose.agents.yml down || true
          docker rm -f aat-monitor-db 2>/dev/null || true
          
          echo "=== [7/8] Building and starting agents ==="
          docker compose -f docker-compose.agents.yml up -d --build
          
          echo "=== [8/8] Waiting and checking status ==="
          sleep 10
          
          docker ps --filter "name=aat-"
          echo ""
          echo "--- Monitor DB logs (last 30 lines) ---"
          docker logs aat-monitor-db --tail 30 || true
          
          echo ""
          echo "=== Deployment completed ==="
          EOF
